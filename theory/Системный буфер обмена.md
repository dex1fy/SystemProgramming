## Системный буфер обмена. Особенности взаимодействия программного обеспечения с системным буфером обмена

**Системный буфер обмена — это "временный склад" для копирования данных между программами.**

---

### **Что это такое?**

Представьте **буфер обмена как листок бумаги**, на который можно временно что-то записать:

1. **Вы копируете** текст в Word → записываете на листок
2. **Вы вставляете** в браузер → считываете с листка
3. **Листок один на весь компьютер** — что запишете новое, старое сотрётся

**Технически:** Это область в оперативной памяти, управляемая ОС.

---

### **Как программы с ним работают?**

#### **1. Копирование (Copy)**
```c
// Программа "кладёт" данные в буфер
if (OpenClipboard(hWnd)) {           // 1. Открываем буфер (берём листок)
    EmptyClipboard();                // 2. Очищаем (стираем старую запись)
    
    // 3. Подготавливаем данные
    char* text = "Привет мир";
    HGLOBAL hMem = GlobalAlloc(GMEM_MOVEABLE, strlen(text) + 1);
    strcpy((char*)GlobalLock(hMem), text);
    GlobalUnlock(hMem);
    
    // 4. Кладём в буфер
    SetClipboardData(CF_TEXT, hMem);  // Говорим: "это текст"
    
    CloseClipboard();                // 5. Закрываем (кладём листок на стол)
}
```

#### **2. Вставка (Paste)**
```c
// Программа "берёт" данные из буфера
if (OpenClipboard(hWnd)) {           // 1. Открываем буфер (берём листок)
    if (IsClipboardFormatAvailable(CF_TEXT)) {  // 2. Проверяем: есть ли текст?
        HGLOBAL hMem = GetClipboardData(CF_TEXT);  // 3. Берём данные
        char* text = (char*)GlobalLock(hMem);      // 4. Читаем
        printf("Из буфера: %s\n", text);          // 5. Используем
        GlobalUnlock(hMem);
    }
    CloseClipboard();                // 6. Закрываем (кладём листок обратно)
}
```

---

### **Особенности взаимодействия**

#### **1. Форматы данных (Что можно копировать?)**

Буфер понимает **разные форматы** одновременно:

| **Формат** | **Что содержит** | **Идентификатор** |
|------------|------------------|------------------|
| **Текст** | "Hello world" | `CF_TEXT` |
| **Rich Text** | Текст с форматированием | `CF_RTF` |
| **HTML** | Веб-страница | `CF_HTML` |
| **Изображение** | Картинка | `CF_BITMAP`, `CF_DIB` |
| **Файлы** | Список файлов | `CF_HDROP` |
| **Специальный** | Данные программы | `CF_PRIVATEFORMAT` |

**Программа может положить одно и то же в разных форматах:**
```c
// Копируя из Word, в буфер попадает:
1. CF_TEXT      -> "Привет" (простой текст)
2. CF_UNICODETEXT -> "Привет" (Unicode)
3. CF_RTF       -> "{\rtf1\ansi{\fonttbl\f0\fswiss Helvetica;}\f0\pard Привет}" 
4. CF_HTML      -> "<html><body>Привет</body></html>"
```

**При вставке программа выбирает нужный ей формат:**
- **Блокнот** возьмёт `CF_TEXT` (простой текст)
- **Word** возьмёт `CF_RTF` (с форматированием)
- **Браузер** возьмёт `CF_HTML`

#### **2. "Очередность владения"**

```c
// Кто последний скопировал — тот "владелец" буфера
OpenClipboard(hWnd);      // Становишься владельцем
SetClipboardData(...);    // Кладёшь данные
CloseClipboard();         // Остаёшься владельцем

// Пока ты владелец:
// - Можешь менять данные в буфере
// - Получаешь уведомления, если кто-то открыл буфер
// - Должен очистить буфер при закрытии программы
```

#### **3. Автоматическое преобразование**

Windows может **автоматически конвертировать** данные:
```c
// Программа просит CF_BITMAP, а в буфере CF_DIB
// Windows сама конвертирует DIB в BITMAP

// Программа просит CF_TEXT, а в буфере CF_UNICODETEXT
// Windows конвертирует Unicode в ANSI
```

#### **4. Отложенная отрисовка (Delayed Rendering)**

**Проблема:** Большие данные (например, 1ГБ файл) — если копировать в буфер напрямую, займёт много памяти.

**Решение:** Кладём только "обещание" данных:
```c
SetClipboardData(CF_BITMAP, NULL);  // Не кладём картинку, а говорим:
// "Когда кто-то попросит картинку — я её нарисую"

// Позже, когда программа запросит вставку:
if (GetClipboardData(CF_BITMAP) == NULL) {
    // Windows вызывает нашу функцию для отрисовки картинки
    RenderBitmapToClipboard();  // Создаём картинку только сейчас
}
```

#### **5. Безопасность и приватность**

**Проблемы:**
1. **Данные в буфере видны всем программам**
2. **Вирусы могут читать** скопированные пароли
3. **Программы могут подменять** данные

**Защита:**
- Банковские приложения **очищают буфер** после копирования паролей
- Некоторые программы **шифруют** данные в буфере
- Windows 10: **облачный буфер** синхронизируется между устройствами

---

### **Примеры из жизни**

#### **Пример 1: Копирование файла**
```c
// 1. Пользователь копирует файл в Проводнике
// Проводник кладёт в буфер:
// CF_HDROP -> "C:\Users\Ivan\Document.txt"

// 2. Пользователь вставляет на Рабочий стол
// Проводник читает CF_HDROP и копирует файл
```

#### **Пример 2: Скриншот**
```c
// 1. Пользователь нажимает PrintScreen
// Windows кладёт в буфер:
// CF_BITMAP -> изображение экрана

// 2. Пользователь открывает Paint и нажимает "Вставить"
// Paint читает CF_BITMAP и показывает картинку
```

#### **Пример 3: Копирование из Excel**
```c
// Excel кладёт в буфер:
// 1. CF_TEXT      -> "1\t2\n3\t4" (табуляции и переводы строк)
// 2. CF_UNICODETEXT -> то же в Unicode
// 3. CF_BIFF      -> внутренний формат Excel
// 4. CF_HTML      -> таблица в HTML

// При вставке:
// - Блокнот возьмёт CF_TEXT -> увидит "1    2"
// - Word возьмёт CF_HTML    -> увидит таблицу
// - Другой Excel возьмёт CF_BIFF -> увидит формулы
```

---

### **Проблемы и ограничения**

1. **Один объект за раз** — скопировали новое, старое удалилось
2. **Нет истории** (кроме Windows 10 с Win+V)
3. **Программа-владелец должна работать** (для отложенной отрисовки)
4. **Разные форматы могут конфликтовать**

---

### **Современные расширения**

#### **Windows 10+ Cloud Clipboard**
```c
// Win + V открывает историю буфера
// Данные синхронизируются между устройствами
// Можно закрепить часто используемое
```

#### **Менеджеры буфера обмена**
- **Ditto** — хранит историю, поиск, синхронизация
- **Clipboard Fusion** — обработка текста при вставке
- **1Clipboard** — облачное хранение

---

### **Код для работы с разными форматами**

```c
// Проверка доступных форматов
if (IsClipboardFormatAvailable(CF_TEXT)) {
    // Есть простой текст
}
if (IsClipboardFormatAvailable(CF_BITMAP)) {
    // Есть картинка
}

// Перечисление всех форматов в буфере
UINT format = 0;
OpenClipboard(hWnd);
while ((format = EnumClipboardFormats(format)) != 0) {
    printf("Формат в буфере: %d\n", format);
}
CloseClipboard();
```

---

### **Основные тезисы:**

1. **Буфер обмена** — общая область памяти для обмена данными
2. **Работает по принципу** "открыл → положил/взял → закрыл"
3. **Поддерживает много форматов** одновременно (текст, картинки, файлы)
4. **Программы выбирают** подходящий им формат
5. **Владелец буфера** — последняя программа, скопировавшая данные
6. **Можно использовать** отложенную отрисовку для больших данных

**Важно:** Буфер обмена — это **системный ресурс**, требующий аккуратной работы. Не забывайте открывать/закрывать его и освобождать память.